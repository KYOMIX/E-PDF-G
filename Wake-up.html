<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Wake-Up Manager</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --text-gray: #7f8c8d;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-main); background-color: #f4f7f6; color: #333; line-height: 1.6; }

        /* --- LAYOUT --- */
        .app-container { max-width: 1200px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
        
        /* Header */
        header { background: var(--primary); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); }
        .brand { font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .header-controls { display: flex; gap: 15px; align-items: center; }
        .lang-toggle { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        
        /* Navigation */
        nav { background: white; padding: 1rem 2rem; border-bottom: 1px solid #ddd; display: flex; gap: 20px; flex-wrap: wrap; }
        .nav-btn { background: none; border: none; padding: 10px 20px; cursor: pointer; font-size: 1rem; color: var(--text-gray); border-radius: 5px; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .nav-btn:hover { background: var(--light); color: var(--primary); }
        .nav-btn.active { background: var(--secondary); color: white; }

        /* Main Content */
        main { flex: 1; padding: 2rem; }
        section { display: none; animation: fadeIn 0.3s ease-in-out; }
        section.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- COMPONENTS --- */
        /* Cards & stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: var(--shadow); border-left: 5px solid var(--secondary); }
        .stat-card h3 { color: var(--text-gray); font-size: 0.9rem; margin-bottom: 5px; }
        .stat-card .value { font-size: 2rem; font-weight: bold; color: var(--primary); }

        /* Forms */
        .form-card { background: white; padding: 30px; border-radius: 8px; box-shadow: var(--shadow); max-width: 800px; margin: 0 auto; }
        .form-group { margin-bottom: 20px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary); }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        input:focus, select:focus { outline: none; border-color: var(--secondary); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); }
        .btn { padding: 12px 24px; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; transition: 0.2s; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--accent); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        
        /* Tables */
        .table-container { background: white; border-radius: 8px; box-shadow: var(--shadow); overflow-x: auto; margin-top: 20px;}
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: var(--primary); font-weight: 600; }
        tr:hover { background: #f1f2f6; }
        
        /* Badges */
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-completed { background: #d4edda; color: #155724; }
        .badge-missed { background: #f8d7da; color: #721c24; }

        /* --- BLOCKLIST STYLES --- */
        .blocklist-container { max-width: 400px; margin: 20px 0; padding: 20px; background: var(--light); border-radius: 8px; }
        .blocklist-list { list-style: none; padding: 0; }
        .blocklist-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dotted #ccc; }
        .blocklist-item:last-child { border-bottom: none; }
        .btn-remove-block { background: none; border: none; color: var(--accent); cursor: pointer; font-size: 1rem; }

        /* --- MODALS --- */
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-backdrop.open { opacity: 1; pointer-events: auto; }
        .modal { background: white; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transform: scale(0.9); transition: 0.3s; overflow: hidden; }
        .modal-backdrop.open .modal { transform: scale(1); }
        .modal-header { padding: 20px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 30px; }
        .modal-footer { padding: 20px; background: #f8f9fa; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #eee; }
        
        /* Alert Modal Specifics */
        .alert-modal .modal-header { background: var(--accent); animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { background-color: var(--accent); } 50% { background-color: #c0392b; } 100% { background-color: var(--accent); } }
        .big-time { font-size: 3rem; text-align: center; font-weight: bold; color: var(--primary); margin: 10px 0; }
        .room-display { font-size: 1.5rem; text-align: center; color: var(--text-gray); }

        /* Voucher/Coupon Style */
        .voucher-preview { border: 2px dashed #333; padding: 20px; background: #fff; margin-bottom: 20px; position: relative; }
        .voucher-header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
        .voucher-details div { margin-bottom: 8px; font-size: 1.1rem; }
        .voucher-footer { margin-top: 20px; font-size: 0.8rem; text-align: center; color: #666; font-style: italic; }

        /* Footer */
        footer { text-align: center; padding: 20px; color: var(--text-gray); font-size: 0.9rem; border-top: 1px solid #ddd; background: white; }
        .status-dot { height: 10px; width: 10px; background-color: var(--success); border-radius: 50%; display: inline-block; margin-right: 5px; }
        .offline-status { background-color: var(--accent) !important; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            nav { justify-content: center; }
            .header-controls { display: none; } /* Simplified for mobile */
        }

        /* --- PRINT STYLES --- */
        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <div class="brand">
                <i class="fas fa-bell"></i>
                <span data-i18n="appTitle">Hotel Wake-Up Manager</span>
            </div>
            <div class="header-controls">
                <span id="clock" style="font-family: monospace; font-size: 1.2rem;">00:00:00</span>
                <button class="lang-toggle" onclick="app.toggleLanguage()">
                    <i class="fas fa-globe"></i> <span id="lang-label">EN/FR</span>
                </button>
            </div>
        </header>

        <nav>
            <button class="nav-btn active" onclick="app.navigate('dashboard')" id="nav-dash">
                <i class="fas fa-tachometer-alt"></i> <span data-i18n="navDash">Dashboard</span>
            </button>
            <button class="nav-btn" onclick="app.navigate('register')" id="nav-reg">
                <i class="fas fa-plus-circle"></i> <span data-i18n="navReg">New Request</span>
            </button>
            <button class="nav-btn" onclick="app.navigate('reports')" id="nav-rep">
                <i class="fas fa-file-alt"></i> <span data-i18n="navRep">Reports / Settings</span>
            </button>
        </nav>

        <main>
            <section id="dashboard" class="active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 data-i18n="statPending">Pending Calls</h3>
                        <div class="value" id="count-pending">0</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--success);">
                        <h3 data-i18n="statCompleted">Completed Today</h3>
                        <div class="value" id="count-completed">0</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--warning);">
                        <h3 data-i18n="statTotal">Total Today</h3>
                        <div class="value" id="count-total">0</div>
                    </div>
                </div>

                <div class="table-header" style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                    <h2 data-i18n="todayCalls">Today's Schedule</h2>
                    <button class="btn btn-outline" onclick="app.renderDashboard()"><i class="fas fa-sync"></i> Refresh</button>
                </div>

                <div class="table-container">
                    <table id="dashboard-table">
                        <thead>
                            <tr>
                                <th data-i18n="colTime">Time</th>
                                <th data-i18n="colRoom">Room</th>
                                <th data-i18n="colGuest">Guest Name</th>
                                <th data-i18n="colLang">Language</th>
                                <th data-i18n="colStatus">Status</th>
                                <th data-i18n="colAction">Action</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-body">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="register">
                <div class="form-card">
                    <h2 style="margin-bottom: 20px; color: var(--primary);" data-i18n="newRequestTitle">Register Wake-Up Call</h2>
                    <form id="wakeup-form" onsubmit="app.handleRegister(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label data-i18n="labelRoom">Room Number *</label>
                                <input type="text" id="reg-room" required placeholder="e.g. 101">
                            </div>
                            <div class="form-group">
                                <label data-i18n="labelGuest">Guest Name</label>
                                <input type="text" id="reg-name" placeholder="Optional">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label data-i18n="labelDate">Start Date *</label>
                                <input type="date" id="reg-date" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="labelTime">Time *</label>
                                <input type="time" id="reg-time" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label data-i18n="labelRecurrence">Recurrence</label>
                                <select id="reg-recurrence">
                                    <option value="single" data-i18n="recSingle">Single Day</option>
                                    <option value="daily" data-i18n="recDaily">Daily (30 days)</option>
                                    <option value="weekly" data-i18n="recWeekly">Weekly (12 weeks)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label data-i18n="labelLang">Language Preference</label>
                                <select id="reg-lang">
                                    <option value="English">English</option>
                                    <option value="French">Français</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label data-i18n="labelNotes">Special Notes</label>
                            <input type="text" id="reg-notes" placeholder="e.g. VIP, Call twice">
                        </div>

                        <div style="text-align: right; margin-top: 20px;">
                            <button type="button" class="btn btn-outline" onclick="app.resetForm()" data-i18n="btnReset">Reset</button>
                            <button type="submit" class="btn btn-primary" data-i18n="btnSave">Save Request</button>
                        </div>
                    </form>
                </div>
            </section>

            <section id="reports">
                <h2 style="color: var(--primary); margin-bottom: 20px;" data-i18n="reportsTitle">Reports & Tools</h2>
                
                <div class="form-card" style="max-width: 450px; float: right; margin-left: 20px;">
                    <h3 data-i18n="blocklistTitle" style="margin-bottom: 15px;">Room Blocklist (DND/OOS)</h3>
                    <p style="font-size: 0.9em; color: var(--text-gray);" data-i18n="blocklistDesc">Prevents wake-up calls from being registered for these rooms.</p>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <input type="text" id="block-room-input" placeholder="Room No." style="flex-grow: 1;">
                        <button class="btn btn-danger" onclick="app.addBlockRoom()"><i class="fas fa-ban"></i> <span data-i18n="addBlock">Block</span></button>
                    </div>
                    
                    <div class="blocklist-container">
                        <ul id="blocklist-ul" class="blocklist-list">
                            </ul>
                    </div>
                </div>

                <div class="form-card" style="max-width: 700px; margin: 0; float: left;">
                    <h3 data-i18n="reportSectionTitle" style="margin-bottom: 15px;">Daily Call Report</h3>
                    <div style="display: flex; gap: 20px; align-items: flex-end; margin-bottom: 20px; flex-wrap: wrap;">
                        <div style="flex: 1;">
                            <label data-i18n="filterDate">Select Date</label>
                            <input type="date" id="report-date" onchange="app.renderReport()">
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="app.exportReportPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
                            <button class="btn btn-outline" onclick="app.exportReportCSV()"><i class="fas fa-file-csv"></i> CSV</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="report-table">
                            <thead>
                                <tr>
                                    <th>Ref ID</th>
                                    <th data-i18n="colTime">Time</th>
                                    <th data-i18n="colRoom">Room</th>
                                    <th data-i18n="colGuest">Guest</th>
                                    <th data-i18n="colStatus">Status</th>
                                    <th data-i18n="colNotes">Notes</th>
                                </tr>
                            </thead>
                            <tbody id="report-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <span class="status-dot" id="online-indicator"></span> <span data-i18n="statusOffline">System Active - Local Storage Enabled</span>
            <br>
            <small>&copy; 2025 Hotel Management Systems. Internal Use Only.</small>
        </footer>
    </div>

    <div id="alert-modal" class="modal-backdrop">
        <div class="modal alert-modal">
            <div class="modal-header">
                <h3><i class="fas fa-bell"></i> <span data-i18n="alertTitle">WAKE UP CALL DUE</span></h3>
            </div>
            <div class="modal-body">
                <div class="big-time" id="alert-time">00:00</div>
                <div class="room-display">
                    <i class="fas fa-door-open"></i> <span data-i18n="colRoom">Room</span>: <b id="alert-room">---</b>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <span id="alert-guest">Guest Name</span> (<span id="alert-lang">Lang</span>)
                </div>
                <p style="text-align: center; color: #666; margin-top: 15px;" id="alert-notes"></p>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn btn-success" id="btn-complete-call" style="width: 100%; font-size: 1.2rem;">
                    <i class="fas fa-check-circle"></i> <span data-i18n="btnComplete">Call Completed</span>
                </button>
            </div>
        </div>
    </div>

    <div id="voucher-modal" class="modal-backdrop">
        <div class="modal">
            <div class="modal-header">
                <h3 data-i18n="voucherTitle">Request Confirmation</h3>
                <button onclick="app.closeModal('voucher-modal')" style="background:none;border:none;color:white;cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div id="printable-voucher" class="voucher-preview">
                    <div class="voucher-header">
                        <h4>HOTEL WAKE-UP SERVICE</h4>
                        <small id="voucher-ref">REF: ---</small>
                    </div>
                    <div class="voucher-details">
                        <div><strong>Room:</strong> <span id="v-room"></span></div>
                        <div><strong>Start Date:</strong> <span id="v-date"></span></div>
                        <div><strong>Time:</strong> <span id="v-time"></span></div>
                        <div><strong>Recurrence:</strong> <span id="v-recurrence"></span></div>
                        <div><strong>Guest:</strong> <span id="v-guest"></span></div>
                        <div><strong>Language:</strong> <span id="v-lang"></span></div>
                    </div>
                    <div class="voucher-footer">
                        <p data-i18n="voucherDisclaimer">Please retain this receipt as proof of your wake-up call request.</p>
                        <small id="v-timestamp"></small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="app.closeModal('voucher-modal')">Close</button>
                <button class="btn btn-primary" onclick="app.printVoucher()"><i class="fas fa-print"></i> Print</button>
            </div>
        </div>
    </div>

    <script>
        const app = {
            data: [],
            blocklist: [],
            currentLang: 'en',
            timerInterval: null,
            audioContext: null,
            activeAlertId: null,

            // Translations Dictionary
            i18n: {
                en: {
                    appTitle: "Hotel Wake-Up Manager",
                    navDash: "Dashboard",
                    navReg: "New Request",
                    navRep: "Reports / Settings",
                    statPending: "Pending Calls",
                    statCompleted: "Completed Today",
                    statTotal: "Total Today",
                    todayCalls: "Today's Schedule",
                    colTime: "Time",
                    colRoom: "Room",
                    colGuest: "Guest Name",
                    colLang: "Language",
                    colStatus: "Status",
                    colAction: "Action",
                    colNotes: "Notes",
                    newRequestTitle: "Register Wake-Up Call",
                    labelRoom: "Room Number *",
                    labelGuest: "Guest Name",
                    labelDate: "Start Date *",
                    labelTime: "Time *",
                    labelRecurrence: "Recurrence",
                    recSingle: "Single Day",
                    recDaily: "Daily (30 days)",
                    recWeekly: "Weekly (12 weeks)",
                    labelLang: "Language Preference",
                    labelNotes: "Special Notes",
                    btnReset: "Reset",
                    btnSave: "Save Request",
                    filterDate: "Select Date",
                    reportsTitle: "Reports & Tools",
                    reportSectionTitle: "Daily Call Report",
                    blocklistTitle: "Room Blocklist (DND/OOS)",
                    blocklistDesc: "Prevents wake-up calls from being registered for these rooms.",
                    addBlock: "Block",
                    alertTitle: "WAKE UP CALL DUE",
                    btnComplete: "Mark Completed",
                    voucherTitle: "Request Confirmation",
                    voucherDisclaimer: "Please retain this receipt as proof of your wake-up call request.",
                    statusOffline: "System Active - Local Storage Enabled",
                    noCalls: "No calls scheduled for today."
                },
                fr: {
                    appTitle: "Gestionnaire Réveil Hôtel",
                    navDash: "Tableau de Bord",
                    navReg: "Nouveau Réveil",
                    navRep: "Rapports / Paramètres",
                    statPending: "En Attente",
                    statCompleted: "Terminés",
                    statTotal: "Total",
                    todayCalls: "Planning du Jour",
                    colTime: "Heure",
                    colRoom: "Chambre",
                    colGuest: "Nom Client",
                    colLang: "Langue",
                    colStatus: "Statut",
                    colAction: "Action",
                    colNotes: "Notes",
                    newRequestTitle: "Enregistrer un Réveil",
                    labelRoom: "Numéro Chambre *",
                    labelGuest: "Nom Client",
                    labelDate: "Date de début *",
                    labelTime: "Heure *",
                    labelRecurrence: "Récurrence",
                    recSingle: "Jour Unique",
                    recDaily: "Quotidien (30 jours)",
                    recWeekly: "Hebdomadaire (12 semaines)",
                    labelLang: "Préférence Langue",
                    labelNotes: "Notes Spéciales",
                    btnReset: "Réinitialiser",
                    btnSave: "Enregistrer",
                    filterDate: "Choisir une Date",
                    reportsTitle: "Rapports & Outils",
                    reportSectionTitle: "Rapport d'Appels",
                    blocklistTitle: "Liste Noire (NPD/HSC)",
                    blocklistDesc: "Empêche l'enregistrement d'appels de réveil pour ces chambres.",
                    addBlock: "Bloquer",
                    alertTitle: "APPEL DE RÉVEIL",
                    btnComplete: "Marquer Terminé",
                    voucherTitle: "Confirmation Demande",
                    voucherDisclaimer: "Veuillez conserver ce reçu comme preuve de votre demande.",
                    statusOffline: "Système Actif - Stockage Local",
                    noCalls: "Aucun appel prévu aujourd'hui."
                }
            },

            init() {
                // Load data
                this.loadData();

                // Load lang
                const savedLang = localStorage.getItem('hotel_lang');
                if (savedLang) this.currentLang = savedLang;

                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('reg-date').value = today;
                document.getElementById('report-date').value = today;

                // Start clock & monitor
                this.updateClock();
                setInterval(() => this.updateClock(), 1000);
                setInterval(() => this.checkAlerts(), 30000); // Check every 30s

                // Initial render
                this.updateUIText();
                this.renderDashboard();
                this.renderBlocklist();
                this.checkOnlineStatus();
            },
            
            checkOnlineStatus() {
                const isOnline = navigator.onLine;
                const indicator = document.getElementById('online-indicator');
                
                if (isOnline) {
                    indicator.classList.remove('offline-status');
                    indicator.style.backgroundColor = 'var(--success)';
                } else {
                    indicator.classList.add('offline-status');
                    indicator.style.backgroundColor = 'var(--accent)';
                }
            },

            // --- NAVIGATION & UI ---
            navigate(sectionId) {
                document.querySelectorAll('section').forEach(el => el.classList.remove('active'));
                document.getElementById(sectionId).classList.add('active');
                
                document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
                document.getElementById(sectionId === 'dashboard' ? 'nav-dash' : sectionId === 'register' ? 'nav-reg' : 'nav-rep').classList.add('active');

                if (sectionId === 'dashboard') this.renderDashboard();
                if (sectionId === 'reports') {
                    this.renderReport();
                    this.renderBlocklist();
                }
            },

            toggleLanguage() {
                this.currentLang = this.currentLang === 'en' ? 'fr' : 'en';
                localStorage.setItem('hotel_lang', this.currentLang);
                this.updateUIText();
                this.renderDashboard(); 
                this.renderBlocklist();
                this.renderReport();
            },

            updateUIText() {
                const t = this.i18n[this.currentLang];
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (t[key]) el.textContent = t[key];
                });
                document.getElementById('lang-label').textContent = this.currentLang === 'en' ? 'EN' : 'FR';
            },

            updateClock() {
                const now = new Date();
                document.getElementById('clock').textContent = now.toLocaleTimeString('en-GB', { hour12: false });
            },

            // --- DATA LOGIC ---
            loadData() {
                const stored = localStorage.getItem('hotel_wakeup_data');
                if (stored) this.data = JSON.parse(stored);
                
                const blockStored = localStorage.getItem('hotel_blocklist');
                if (blockStored) this.blocklist = JSON.parse(blockStored);
            },
            
            saveData() {
                localStorage.setItem('hotel_wakeup_data', JSON.stringify(this.data));
            },
            
            saveBlocklist() {
                localStorage.setItem('hotel_blocklist', JSON.stringify(this.blocklist));
            },
            
            // --- BLOCKLIST MANAGEMENT ---
            addBlockRoom() {
                const room = document.getElementById('block-room-input').value.trim().toUpperCase();
                if (!room) return;
                
                if (!this.blocklist.includes(room)) {
                    this.blocklist.push(room);
                    this.saveBlocklist();
                    this.renderBlocklist();
                    document.getElementById('block-room-input').value = '';
                } else {
                    alert(`Room ${room} is already blocked.`);
                }
            },

            removeBlockRoom(room) {
                this.blocklist = this.blocklist.filter(r => r !== room);
                this.saveBlocklist();
                this.renderBlocklist();
            },
            
            renderBlocklist() {
                const ul = document.getElementById('blocklist-ul');
                ul.innerHTML = '';
                
                if (this.blocklist.length === 0) {
                    ul.innerHTML = `<li style="color: var(--text-gray);">No rooms currently blocked.</li>`;
                    return;
                }
                
                this.blocklist.forEach(room => {
                    const li = document.createElement('li');
                    li.classList.add('blocklist-item');
                    li.innerHTML = `
                        <span><i class="fas fa-bed"></i> <strong>${room}</strong></span>
                        <button class="btn-remove-block" onclick="app.removeBlockRoom('${room}')" title="Unblock"><i class="fas fa-times-circle"></i></button>
                    `;
                    ul.appendChild(li);
                });
            },

            // --- REGISTRATION ---
            handleRegister(e) {
                e.preventDefault();
                
                const room = document.getElementById('reg-room').value.trim().toUpperCase();
                const date = document.getElementById('reg-date').value;
                const time = document.getElementById('reg-time').value;
                const recurrence = document.getElementById('reg-recurrence').value;
                
                // 1. Blocklist Validation
                if (this.blocklist.includes(room)) {
                    alert(`ERROR: Room ${room} is on the Blocklist (DND/OOS). Cannot register call.`);
                    return;
                }
                
                // 2. Initial Date Validation
                const now = new Date();
                const scheduleDate = new Date(date + 'T' + time);
                if (scheduleDate < now) {
                    alert("Cannot schedule calls in the past.");
                    return;
                }

                // 3. Generate Calls based on Recurrence
                const newCalls = [];
                const baseCall = {
                    roomNumber: room,
                    guestName: document.getElementById('reg-name').value.trim() || 'Guest',
                    time: time,
                    language: document.getElementById('reg-lang').value,
                    notes: document.getElementById('reg-notes').value.trim(),
                    status: 'pending',
                    requestedAt: new Date().toISOString(),
                    completedAt: null
                };

                let iterations = 1;
                if (recurrence === 'daily') iterations = 30; // 30 days max
                if (recurrence === 'weekly') iterations = 12; // 12 weeks max
                
                let currentDate = new Date(date); // Start date

                for (let i = 0; i < iterations; i++) {
                    const callDateStr = currentDate.toISOString().split('T')[0];
                    
                    // Check duplicate for this specific date
                    const exists = this.data.find(c => c.date === callDateStr && c.time === time && c.roomNumber === room && c.status === 'pending');
                    if (exists) {
                        // Skip this date, continue to the next one
                        currentDate = this.getNextDate(currentDate, recurrence);
                        continue;
                    }
                    
                    const call = {
                        ...baseCall,
                        id: Date.now().toString() + i, // unique ID
                        reference: `WUC-${callDateStr.replace(/-/g, '')}-${i.toString().padStart(2, '0')}`,
                        date: callDateStr,
                        recurrenceType: recurrence 
                    };
                    newCalls.push(call);
                    
                    currentDate = this.getNextDate(currentDate, recurrence);
                }

                if (newCalls.length === 0) {
                    alert("Registration failed: All requested time slots were already booked or in the past.");
                    return;
                }

                this.data.push(...newCalls);
                this.saveData();
                this.showVoucher(baseCall, date, recurrence, newCalls.length); // Show voucher based on base data
                this.resetForm();
            },
            
            getNextDate(currentDate, recurrence) {
                const nextDate = new Date(currentDate);
                if (recurrence === 'daily') {
                    nextDate.setDate(nextDate.getDate() + 1);
                } else if (recurrence === 'weekly') {
                    nextDate.setDate(nextDate.getDate() + 7);
                }
                return nextDate;
            },

            resetForm() {
                document.getElementById('wakeup-form').reset();
                document.getElementById('reg-date').value = new Date().toISOString().split('T')[0];
            },

            markCompleted(id) {
                const call = this.data.find(c => c.id === id);
                if (call) {
                    if (confirm("Confirm wake-up call completed?")) {
                        call.status = 'completed';
                        call.completedAt = new Date().toISOString();
                        this.saveData();
                        this.renderDashboard();
                        
                        // If it was the active alert
                        if (this.activeAlertId === id) {
                            this.closeModal('alert-modal');
                            this.stopAlarm();
                        }
                    }
                }
            },

            // --- DASHBOARD ---
            renderDashboard() {
                const today = new Date().toISOString().split('T')[0];
                // Filter out records older than 30 days just to keep the data clean and dashboard fast
                const thirtyDaysAgo = new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0];
                
                this.data = this.data.filter(c => c.date >= thirtyDaysAgo || c.date === today); 
                this.saveData(); // Save cleaned up list
                
                const calls = this.data.filter(c => c.date === today).sort((a,b) => a.time.localeCompare(b.time));
                
                // Update counters
                const total = calls.length;
                const completed = calls.filter(c => c.status === 'completed').length;
                const pending = total - completed;

                document.getElementById('count-pending').textContent = pending;
                document.getElementById('count-completed').textContent = completed;
                document.getElementById('count-total').textContent = total;

                // Render Table
                const tbody = document.getElementById('dashboard-body');
                tbody.innerHTML = '';

                if (calls.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 20px;">${this.i18n[this.currentLang].noCalls}</td></tr>`;
                    return;
                }

                calls.forEach(call => {
                    const statusClass = call.status === 'completed' ? 'badge-completed' : 'badge-pending';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${call.time}</strong></td>
                        <td><i class="fas fa-door-closed"></i> ${call.roomNumber}</td>
                        <td>${call.guestName}</td>
                        <td>${call.language}</td>
                        <td><span class="badge ${statusClass}">${call.status.toUpperCase()}</span></td>
                        <td>
                            ${call.status === 'pending' ? 
                                `<button class="btn btn-success" style="padding: 5px 10px; font-size: 0.8rem;" onclick="app.markCompleted('${call.id}')"><i class="fas fa-check"></i></button>` 
                                : '<i class="fas fa-check-circle" style="color:var(--success)"></i>'}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            },

            // --- ALERTS ---
            checkAlerts() {
                const now = new Date();
                const currentDate = now.toISOString().split('T')[0];
                // Get HH:MM format
                const currentTime = now.toLocaleTimeString('en-GB', { hour12: false }).substring(0, 5);

                const dueCall = this.data.find(c => 
                    c.date === currentDate && 
                    c.time === currentTime && 
                    c.status === 'pending'
                );

                if (dueCall && this.activeAlertId !== dueCall.id) {
                    this.triggerAlert(dueCall);
                }
            },

            triggerAlert(call) {
                this.activeAlertId = call.id;
                
                // Populate Modal
                document.getElementById('alert-time').textContent = call.time;
                document.getElementById('alert-room').textContent = call.roomNumber;
                document.getElementById('alert-guest').textContent = call.guestName;
                document.getElementById('alert-lang').textContent = call.language;
                document.getElementById('alert-notes').textContent = call.notes ? `Note: ${call.notes}` : '';
                
                // Bind Button
                const btn = document.getElementById('btn-complete-call');
                btn.onclick = () => this.markCompleted(call.id);

                // Show & Play
                document.getElementById('alert-modal').classList.add('open');
                this.playAlarmSound();
            },

            playAlarmSound() {
                // Using Web Audio API for no-asset sound
                if (!this.audioContext) this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                const playBeep = () => {
                    if (this.activeAlertId === null) return; // Stop if alert dismissed
                    
                    const osc = this.audioContext.createOscillator();
                    const gain = this.audioContext.createGain();
                    
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(440, this.audioContext.currentTime); // A4
                    osc.frequency.exponentialRampToValueAtTime(880, this.audioContext.currentTime + 0.1); // Slide up
                    
                    gain.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.5);

                    osc.connect(gain);
                    gain.connect(this.audioContext.destination);
                    
                    osc.start();
                    osc.stop(this.audioContext.currentTime + 0.5);
                };

                // Play immediately then loop
                playBeep();
                this.timerInterval = setInterval(playBeep, 2000); // Beep every 2 seconds
            },

            stopAlarm() {
                clearInterval(this.timerInterval);
                this.activeAlertId = null;
            },

            // --- VOUCHERS ---
            showVoucher(call, startDate, recurrence, count) {
                document.querySelector('#voucher-ref').textContent = `REF: ${call.reference}`;
                document.getElementById('v-room').textContent = call.roomNumber;
                document.getElementById('v-date').textContent = startDate;
                document.getElementById('v-time').textContent = call.time;
                
                let recurrenceText = recurrence === 'single' ? 'Single Day' : 
                                     recurrence === 'daily' ? `Daily (${count} instances)` : 
                                     `Weekly (${count} instances)`;

                document.getElementById('v-recurrence').textContent = recurrenceText;
                document.getElementById('v-guest').textContent = call.guestName;
                document.getElementById('v-lang').textContent = call.language;
                document.getElementById('v-timestamp').textContent = "Issued: " + new Date(call.requestedAt).toLocaleString();
                
                document.getElementById('voucher-modal').classList.add('open');
            },

            printVoucher() {
                // Clone the voucher, put it in a printable wrapper
                const content = document.getElementById('printable-voucher').innerHTML;
                const printArea = document.createElement('div');
                printArea.id = 'printable-area';
                printArea.innerHTML = `<div style="padding: 40px; border: 1px solid #ccc;">${content}</div>`;
                document.body.appendChild(printArea);
                window.print();
                document.body.removeChild(printArea);
            },

            closeModal(id) {
                document.getElementById(id).classList.remove('open');
                if (id === 'alert-modal') this.stopAlarm();
            },

            // --- REPORTS ---
            renderReport() {
                const date = document.getElementById('report-date').value;
                const calls = this.data.filter(c => c.date === date).sort((a,b) => a.time.localeCompare(b.time));
                
                const tbody = document.getElementById('report-body');
                tbody.innerHTML = '';

                if (calls.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No records for this date.</td></tr>`;
                    return;
                }

                calls.forEach(call => {
                    tbody.innerHTML += `
                        <tr>
                            <td><small>${call.reference}</small></td>
                            <td>${call.time}</td>
                            <td>${call.roomNumber}</td>
                            <td>${call.guestName}</td>
                            <td>${call.status}</td>
                            <td><small>${call.notes || '-'}</small></td>
                        </tr>
                    `;
                });
            },

            exportReportPDF() {
                const date = document.getElementById('report-date').value;
                const calls = this.data.filter(c => c.date === date).sort((a,b) => a.time.localeCompare(b.time));
                
                if (calls.length === 0) { alert("No data to export"); return; }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(18);
                doc.text(`Wake-Up Call Report: ${date}`, 14, 22);
                doc.setFontSize(11);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 30);

                const rows = calls.map(c => [c.time, c.roomNumber, c.guestName, c.language, c.status.toUpperCase(), c.notes]);

                doc.autoTable({
                    head: [['Time', 'Room', 'Guest', 'Lang', 'Status', 'Notes']],
                    body: rows,
                    startY: 40,
                });

                doc.save(`wakeup_report_${date}.pdf`);
            },

            exportReportCSV() {
                const date = document.getElementById('report-date').value;
                const calls = this.data.filter(c => c.date === date);
                
                if (calls.length === 0) { alert("No data to export"); return; }

                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Reference,Date,Time,Room,Guest,Language,Status,Notes\n";

                calls.forEach(c => {
                    const row = [
                        c.reference, c.date, c.time, c.roomNumber, 
                        `"${c.guestName}"`, c.language, c.status, `"${c.notes}"`
                    ].join(",");
                    csvContent += row + "\r\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `wakeup_report_${date}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        // Start App
        document.addEventListener('DOMContentLoaded', () => app.init());
        window.addEventListener('online', app.checkOnlineStatus);
        window.addEventListener('offline', app.checkOnlineStatus);
    </script>
</body>
</html>
