<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Wake-Up Manager</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* --- PREMIUM GLASSMORPHISM THEME --- */
        :root {
            --primary: linear-gradient(135deg, #2c3e50, #1a2530);
            --secondary: linear-gradient(135deg, #3498db, #2980b9);
            --accent: linear-gradient(135deg, #e74c3c, #c0392b);
            --success: linear-gradient(135deg, #27ae60, #219653);
            --warning: linear-gradient(135deg, #f39c12, #e67e22);
            --light: rgba(255, 255, 255, 0.95);
            --dark: rgba(44, 62, 80, 0.95);
            --text-gray: #7f8c8d;
            --font-main: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --glass-blur: blur(12px);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            --shadow-hover: 0 16px 48px rgba(0, 0, 0, 0.18);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: var(--font-main); 
            background: linear-gradient(135deg, #f4f7f6 0%, #e3e7ed 100%);
            color: #333; 
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated Background Elements */
        body::before {
            content: '';
            position: fixed;
            width: 500px;
            height: 500px;
            border-radius: 50%;
            background: linear-gradient(45deg, rgba(52, 152, 219, 0.1), rgba(41, 128, 185, 0.05));
            top: -250px;
            right: -250px;
            z-index: -1;
            animation: float 25s infinite alternate ease-in-out;
        }

        body::after {
            content: '';
            position: fixed;
            width: 400px;
            height: 400px;
            border-radius: 50%;
            background: linear-gradient(45deg, rgba(231, 76, 60, 0.08), rgba(192, 57, 43, 0.04));
            bottom: -200px;
            left: -200px;
            z-index: -1;
            animation: float 20s infinite alternate-reverse ease-in-out;
        }

        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(30px, 30px) rotate(180deg); }
        }

        /* --- LAYOUT --- */
        .app-container { 
            max-width: 1200px; 
            margin: 0 auto; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column;
            position: relative;
            z-index: 1;
        }
        
        /* Premium Header with Glassmorphism */
        header { 
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            color: #2c3e50; 
            padding: 1.2rem 2rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: var(--shadow);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            z-index: 100;
        }
        
        .brand { 
            font-size: 1.5rem; 
            font-weight: 800; 
            display: flex; 
            align-items: center; 
            gap: 12px;
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .brand i {
            background: var(--secondary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.8rem;
        }
        
        .header-controls { display: flex; gap: 15px; align-items: center; }
        
        .lang-toggle { 
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.2);
            color: #3498db; 
            padding: 8px 16px; 
            border-radius: 25px; 
            cursor: pointer; 
            transition: var(--transition);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .lang-toggle:hover {
            background: rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }

        /* Navigation with Glassmorphism */
        nav { 
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            padding: 0.8rem 2rem; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            display: flex; 
            gap: 15px; 
            flex-wrap: wrap;
            position: relative;
            z-index: 90;
        }
        
        .nav-btn { 
            background: transparent; 
            border: 2px solid transparent; 
            padding: 10px 20px; 
            cursor: pointer; 
            font-size: 1rem; 
            color: var(--text-gray); 
            border-radius: 12px; 
            transition: var(--transition); 
            display: flex; 
            align-items: center; 
            gap: 8px;
            font-weight: 600;
        }
        
        .nav-btn:hover { 
            background: rgba(52, 152, 219, 0.1); 
            color: #3498db; 
            transform: translateY(-2px);
            border-color: rgba(52, 152, 219, 0.2);
        }
        
        .nav-btn.active { 
            background: var(--secondary); 
            color: white; 
            box-shadow: 0 4px 20px rgba(52, 152, 219, 0.3);
            transform: translateY(-2px);
        }

        /* Main Content */
        main { 
            flex: 1; 
            padding: 2rem;
            position: relative;
            z-index: 50;
        }
        
        section { 
            display: none; 
            animation: fadeIn 0.4s ease-out; 
        }
        
        section.active { display: block; }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(15px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* --- PREMIUM COMPONENTS --- */
        /* Stats Cards with Glassmorphism */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 25px; 
            margin-bottom: 40px; 
        }
        
        .stat-card { 
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--secondary);
        }
        
        .stat-card:nth-child(2)::before { background: var(--success); }
        .stat-card:nth-child(3)::before { background: var(--warning); }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }
        
        .stat-card h3 { 
            color: var(--text-gray); 
            font-size: 0.9rem; 
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .value { 
            font-size: 2.5rem; 
            font-weight: 800; 
            color: #2c3e50;
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Forms with Glassmorphism */
        .form-card { 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            padding: 35px; 
            border-radius: 24px; 
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.4);
            max-width: 800px; 
            margin: 0 auto;
            transition: var(--transition);
        }
        
        .form-card:hover {
            box-shadow: var(--shadow-hover);
        }
        
        .form-group { margin-bottom: 25px; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        
        label { 
            display: block; 
            margin-bottom: 10px; 
            font-weight: 700; 
            color: #2c3e50;
            font-size: 0.95rem;
        }
        
        input, select, textarea { 
            width: 100%; 
            padding: 14px; 
            border: 2px solid rgba(52, 152, 219, 0.1); 
            border-radius: 12px; 
            font-size: 1rem; 
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.9);
        }
        
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: #3498db; 
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.15); 
            background: white;
        }
        
        .btn { 
            padding: 14px 28px; 
            border: none; 
            border-radius: 12px; 
            font-size: 1rem; 
            cursor: pointer; 
            transition: var(--transition); 
            font-weight: 700; 
            display: inline-flex; 
            align-items: center; 
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        
        .btn:hover::after {
            left: 100%;
        }
        
        .btn-primary { 
            background: var(--secondary); 
            color: white; 
        }
        
        .btn-primary:hover { 
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success { 
            background: var(--success); 
            color: white; 
        }
        
        .btn-danger { 
            background: var(--accent); 
            color: white; 
        }
        
        .btn-outline { 
            background: transparent; 
            border: 2px solid rgba(52, 152, 219, 0.3); 
            color: #3498db; 
        }
        
        .btn-outline:hover {
            background: rgba(52, 152, 219, 0.1);
            transform: translateY(-3px);
        }

        /* Tables with Glassmorphism */
        .table-container { 
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-radius: 20px; 
            box-shadow: var(--shadow);
            overflow-x: auto; 
            margin-top: 25px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 600px; }
        
        th, td { 
            padding: 18px 24px; 
            text-align: left; 
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        th { 
            background: rgba(52, 152, 219, 0.08); 
            color: #2c3e50; 
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        tr:hover { background: rgba(52, 152, 219, 0.05); }
        
        tr:last-child td { border-bottom: none; }

        /* Badges with Gradients */
        .badge { 
            padding: 8px 16px; 
            border-radius: 25px; 
            font-size: 0.8rem; 
            font-weight: 700; 
            display: inline-block;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .badge-pending { 
            background: var(--warning); 
            color: white; 
        }
        
        .badge-completed { 
            background: var(--success); 
            color: white; 
        }
        
        .badge-missed { 
            background: var(--accent); 
            color: white; 
        }

        /* Blocklist Styles */
        .blocklist-container { 
            max-width: 400px; 
            margin: 20px 0; 
            padding: 25px; 
            background: rgba(236, 240, 241, 0.9);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-radius: 20px; 
            border: 1px solid rgba(52, 152, 219, 0.1);
        }
        
        .blocklist-list { list-style: none; padding: 0; }
        
        .blocklist-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 0; 
            border-bottom: 1px dotted rgba(0,0,0,0.1); 
            transition: var(--transition);
        }
        
        .blocklist-item:hover {
            transform: translateX(5px);
        }
        
        .blocklist-item:last-child { border-bottom: none; }
        
        .btn-remove-block { 
            background: none; 
            border: none; 
            color: #e74c3c; 
            cursor: pointer; 
            font-size: 1.1rem; 
            transition: var(--transition);
        }
        
        .btn-remove-block:hover {
            transform: scale(1.2);
        }

        /* Premium Modals */
        .modal-backdrop { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.7); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
            opacity: 0; 
            pointer-events: none; 
            transition: var(--transition);
            backdrop-filter: blur(5px);
        }
        
        .modal-backdrop.open { opacity: 1; pointer-events: auto; }
        
        .modal { 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            width: 90%; 
            max-width: 500px; 
            border-radius: 24px; 
            box-shadow: 0 25px 50px rgba(0,0,0,0.25); 
            transform: scale(0.9) translateY(20px); 
            transition: var(--transition); 
            overflow: hidden; 
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        
        .modal-backdrop.open .modal { transform: scale(1) translateY(0); }
        
        .modal-header { 
            padding: 25px; 
            background: var(--primary); 
            color: white; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .modal-body { padding: 35px; }
        
        .modal-footer { 
            padding: 25px; 
            background: rgba(248, 249, 250, 0.9); 
            display: flex; 
            justify-content: flex-end; 
            gap: 15px; 
            border-top: 1px solid rgba(0,0,0,0.05); 
        }
        
        /* Alert Modal Specifics */
        .alert-modal .modal-header { 
            background: var(--accent); 
            animation: pulse-red 1.5s infinite;
            position: relative;
            overflow: hidden;
        }
        
        .alert-modal .modal-header::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            top: 0;
            left: -100%;
            animation: slide 1.5s infinite;
        }
        
        @keyframes slide {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        @keyframes pulse-red { 
            0% { background: linear-gradient(135deg, #e74c3c, #c0392b); } 
            50% { background: linear-gradient(135deg, #c0392b, #e74c3c); } 
            100% { background: linear-gradient(135deg, #e74c3c, #c0392b); } 
        }
        
        .big-time { 
            font-size: 3.5rem; 
            text-align: center; 
            font-weight: 800; 
            color: #2c3e50; 
            margin: 15px 0;
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .room-display { 
            font-size: 1.6rem; 
            text-align: center; 
            color: var(--text-gray); 
        }

        /* Premium Voucher/Coupon Style */
        .voucher-preview { 
            border: 3px dashed #2c3e50; 
            padding: 30px; 
            background: white; 
            margin-bottom: 25px; 
            position: relative;
            border-radius: 20px;
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .voucher-preview::before,
        .voucher-preview::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: #f4f7f6;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: inset 0 0 0 3px #2c3e50;
        }
        
        .voucher-preview::before {
            left: -10px;
        }
        
        .voucher-preview::after {
            right: -10px;
        }
        
        .voucher-header { 
            text-align: center; 
            border-bottom: 2px solid #2c3e50; 
            padding-bottom: 15px; 
            margin-bottom: 20px; 
        }
        
        .voucher-details div { 
            margin-bottom: 12px; 
            font-size: 1.1rem; 
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .voucher-details div:last-child {
            border-bottom: none;
        }
        
        .voucher-footer { 
            margin-top: 25px; 
            font-size: 0.85rem; 
            text-align: center; 
            color: #666; 
            font-style: italic; 
        }

        /* Footer */
        footer { 
            text-align: center; 
            padding: 25px; 
            color: var(--text-gray); 
            font-size: 0.9rem; 
            border-top: 1px solid rgba(0,0,0,0.05); 
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            margin-top: auto;
            position: relative;
            z-index: 100;
        }
        
        .status-dot { 
            height: 12px; 
            width: 12px; 
            background: var(--success); 
            border-radius: 50%; 
            display: inline-block; 
            margin-right: 8px; 
            box-shadow: 0 0 0 rgba(39, 174, 96, 0.4);
            animation: pulse-green 2s infinite;
            vertical-align: middle;
        }
        
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(39, 174, 96, 0); }
            100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); }
        }
        
        .offline-status { 
            background: var(--accent) !important; 
            animation: pulse-red 1.5s infinite !important;
        }

        /* Loading Indicator */
        .loader { 
            display: inline-block; 
            width: 24px; 
            height: 24px; 
            border: 3px solid rgba(52, 152, 219, 0.1); 
            border-top: 3px solid #3498db; 
            border-radius: 50%; 
            animation: spin 0.8s linear infinite; 
            margin-right: 10px;
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* Mobile FAB (Floating Action Button) */
        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 999;
            display: none;
        }
        
        .fab {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--secondary);
            color: white;
            border: none;
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: var(--transition);
        }
        
        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 12px 35px rgba(52, 152, 219, 0.4);
        }
        
        .fab-menu {
            position: absolute;
            bottom: 70px;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: var(--glass-blur);
            border-radius: 20px;
            padding: 10px;
            box-shadow: var(--shadow);
            display: none;
            flex-direction: column;
            gap: 10px;
            min-width: 180px;
        }
        
        .fab-menu.active {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fab-menu-item {
            padding: 12px 20px;
            border-radius: 12px;
            background: transparent;
            border: none;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition);
            color: #2c3e50;
            font-weight: 600;
        }
        
        .fab-menu-item:hover {
            background: rgba(52, 152, 219, 0.1);
            transform: translateX(-5px);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            nav { 
                display: none; /* Hide regular nav on mobile */
            }
            .header-controls { gap: 10px; }
            
            /* Show FAB on mobile */
            .fab-container {
                display: block;
            }
            
            /* Adjust padding */
            .form-card, .modal-body, .modal-footer {
                padding: 20px;
            }
            
            /* Smaller stats */
            .stat-card .value {
                font-size: 2rem;
            }
            
            /* Adjust table */
            th, td {
                padding: 12px 15px;
            }
            
            /* Floating sections for mobile */
            .form-card, .table-container, .blocklist-container {
                margin-bottom: 20px;
            }
        }

        /* Large Screen Enhancements */
        @media (min-width: 1400px) {
            .app-container {
                max-width: 1400px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* --- PRINT STYLES --- */
        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <div class="brand">
                <i class="fas fa-bell"></i>
                <span data-i18n="appTitle">Hotel Wake-Up Manager</span>
            </div>
            <div class="header-controls">
                <span id="clock" style="font-family: monospace; font-size: 1.2rem; font-weight: 600;">00:00:00</span>
                <button class="lang-toggle" onclick="app.toggleLanguage()">
                    <i class="fas fa-globe"></i> <span id="lang-label">EN/FR</span>
                </button>
            </div>
        </header>

        <nav class="no-print">
            <button class="nav-btn active" onclick="app.navigate('dashboard')" id="nav-dash">
                <i class="fas fa-tachometer-alt"></i> <span data-i18n="navDash">Dashboard</span>
            </button>
            <button class="nav-btn" onclick="app.navigate('register')" id="nav-reg">
                <i class="fas fa-plus-circle"></i> <span data-i18n="navReg">New Request</span>
            </button>
            <button class="nav-btn" onclick="app.navigate('reports')" id="nav-rep">
                <i class="fas fa-file-alt"></i> <span data-i18n="navRep">Reports / Settings</span>
            </button>
        </nav>

        <main>
            <section id="dashboard" class="active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 data-i18n="statPending">Pending Calls</h3>
                        <div class="value" id="count-pending">0</div>
                    </div>
                    <div class="stat-card">
                        <h3 data-i18n="statCompleted">Completed Today</h3>
                        <div class="value" id="count-completed">0</div>
                    </div>
                    <div class="stat-card">
                        <h3 data-i18n="statTotal">Total Today</h3>
                        <div class="value" id="count-total">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Blocked Rooms</h3>
                        <div class="value" id="count-blocked">0</div>
                    </div>
                </div>

                <div class="table-header" style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                    <h2 style="color: #2c3e50; font-weight: 700;" data-i18n="todayCalls">Today's Schedule</h2>
                    <button class="btn btn-outline" onclick="app.renderDashboard()" id="refresh-btn">
                        <i class="fas fa-sync"></i> <span data-i18n="btnRefresh">Refresh</span>
                    </button>
                </div>

                <div class="table-container">
                    <table id="dashboard-table">
                        <thead>
                            <tr>
                                <th data-i18n="colTime">Time</th>
                                <th data-i18n="colRoom">Room</th>
                                <th data-i18n="colGuest">Guest Name</th>
                                <th data-i18n="colLang">Language</th>
                                <th data-i18n="colStatus">Status</th>
                                <th data-i18n="colAction">Action</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-body">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="register">
                <div class="form-card">
                    <h2 style="margin-bottom: 25px; color: #2c3e50; font-weight: 800;" data-i18n="newRequestTitle">Register Wake-Up Call</h2>
                    <form id="wakeup-form" onsubmit="app.handleRegister(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label data-i18n="labelRoom">Room Number *</label>
                                <input type="text" id="reg-room" required placeholder="e.g. 101">
                            </div>
                            <div class="form-group">
                                <label data-i18n="labelGuest">Guest Name</label>
                                <input type="text" id="reg-name" placeholder="Optional">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label data-i18n="labelDate">Start Date *</label>
                                <input type="date" id="reg-date" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="labelTime">Time *</label>
                                <input type="time" id="reg-time" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label data-i18n="labelRecurrence">Recurrence</label>
                                <select id="reg-recurrence">
                                    <option value="single" data-i18n="recSingle">Single Day</option>
                                    <option value="daily" data-i18n="recDaily">Daily (30 days)</option>
                                    <option value="weekly" data-i18n="recWeekly">Weekly (12 weeks)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label data-i18n="labelLang">Language Preference</label>
                                <select id="reg-lang">
                                    <option value="English">English</option>
                                    <option value="French">Français</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label data-i18n="labelNotes">Special Notes</label>
                            <input type="text" id="reg-notes" placeholder="e.g. VIP, Call twice">
                        </div>

                        <div style="text-align: right; margin-top: 30px;">
                            <button type="button" class="btn btn-outline" onclick="app.resetForm()" data-i18n="btnReset">Reset</button>
                            <button type="submit" class="btn btn-primary" id="save-btn" data-i18n="btnSave">Save Request</button>
                        </div>
                    </form>
                </div>
            </section>

            <section id="reports">
                <h2 style="color: #2c3e50; margin-bottom: 25px; font-weight: 800;" data-i18n="reportsTitle">Reports & Tools</h2>
                
                <div class="form-card" style="max-width: 450px; float: right; margin-left: 25px;">
                    <h3 data-i18n="blocklistTitle" style="margin-bottom: 15px;">Room Blocklist (DND/OOS)</h3>
                    <p style="font-size: 0.9em; color: var(--text-gray); margin-bottom: 20px;" data-i18n="blocklistDesc">Prevents wake-up calls from being registered for these rooms.</p>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <input type="text" id="block-room-input" placeholder="Room No." style="flex-grow: 1; padding: 12px;">
                        <button class="btn btn-danger" onclick="app.addBlockRoom()" id="block-btn">
                            <i class="fas fa-ban"></i> <span data-i18n="addBlock">Block</span>
                        </button>
                    </div>
                    
                    <div class="blocklist-container" style="margin-top: 20px;">
                        <ul id="blocklist-ul" class="blocklist-list">
                            </ul>
                    </div>
                </div>

                <div class="form-card" style="max-width: 700px; margin: 0; float: left;">
                    <h3 data-i18n="reportSectionTitle" style="margin-bottom: 20px;">Daily Call Report</h3>
                    <div style="display: flex; gap: 20px; align-items: flex-end; margin-bottom: 25px; flex-wrap: wrap;">
                        <div style="flex: 1;">
                            <label data-i18n="filterDate">Select Date</label>
                            <input type="date" id="report-date" onchange="app.renderReport()" style="padding: 12px;">
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="app.exportReportPDF()" id="pdf-btn">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <button class="btn btn-outline" onclick="app.exportReportCSV()" id="csv-btn">
                                <i class="fas fa-file-csv"></i> CSV
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="report-table">
                            <thead>
                                <tr>
                                    <th>Ref ID</th>
                                    <th data-i18n="colTime">Time</th>
                                    <th data-i18n="colRoom">Room</th>
                                    <th data-i18n="colGuest">Guest</th>
                                    <th data-i18n="colStatus">Status</th>
                                    <th data-i18n="colNotes">Notes</th>
                                </tr>
                            </thead>
                            <tbody id="report-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <span class="status-dot" id="online-indicator"></span> 
            <span id="status-text" data-i18n="statusOnline">System Active - PHP Backend</span>
            <br>
            <small>&copy; 2025 Hotel Management Systems. Internal Use Only.</small>
        </footer>
    </div>

    <!-- Mobile FAB -->
    <div class="fab-container no-print">
        <div class="fab" onclick="app.toggleFabMenu()">
            <i class="fas fa-bars"></i>
        </div>
        <div class="fab-menu" id="fab-menu">
            <button class="fab-menu-item" onclick="app.navigate('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="fab-menu-item" onclick="app.navigate('register')">
                <i class="fas fa-plus-circle"></i> New Request
            </button>
            <button class="fab-menu-item" onclick="app.navigate('reports')">
                <i class="fas fa-file-alt"></i> Reports
            </button>
            <button class="fab-menu-item" onclick="app.toggleLanguage()">
                <i class="fas fa-globe"></i> Switch Language
            </button>
        </div>
    </div>

    <div id="alert-modal" class="modal-backdrop">
        <div class="modal alert-modal">
            <div class="modal-header">
                <h3 style="display: flex; align-items: center; gap: 10px;"><i class="fas fa-bell fa-shake"></i> <span data-i18n="alertTitle">WAKE UP CALL DUE</span></h3>
            </div>
            <div class="modal-body">
                <div class="big-time" id="alert-time">00:00</div>
                <div class="room-display">
                    <i class="fas fa-door-open"></i> <span data-i18n="colRoom">Room</span>: <b id="alert-room">---</b>
                </div>
                <div style="text-align: center; margin-top: 15px; font-size: 1.2rem;">
                    <span id="alert-guest">Guest Name</span> (<span id="alert-lang">Lang</span>)
                </div>
                <p style="text-align: center; color: #666; margin-top: 20px; padding: 15px; background: rgba(52, 152, 219, 0.05); border-radius: 12px;" id="alert-notes"></p>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn btn-success" id="btn-complete-call" style="width: 100%; font-size: 1.2rem; padding: 16px;">
                    <i class="fas fa-check-circle"></i> <span data-i18n="btnComplete">Call Completed</span>
                </button>
            </div>
        </div>
    </div>

    <div id="voucher-modal" class="modal-backdrop">
        <div class="modal">
            <div class="modal-header">
                <h3 data-i18n="voucherTitle">Request Confirmation</h3>
                <button onclick="app.closeModal('voucher-modal')" style="background:none;border:none;color:white;cursor:pointer;font-size:1.2rem;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div id="printable-voucher" class="voucher-preview">
                    <div class="voucher-header">
                        <h4 style="color: #2c3e50; font-weight: 800;">HOTEL WAKE-UP SERVICE</h4>
                        <small id="voucher-ref" style="color: #3498db; font-weight: 600;">REF: ---</small>
                    </div>
                    <div class="voucher-details">
                        <div><strong>Room:</strong> <span id="v-room"></span></div>
                        <div><strong>Start Date:</strong> <span id="v-date"></span></div>
                        <div><strong>Time:</strong> <span id="v-time"></span></div>
                        <div><strong>Recurrence:</strong> <span id="v-recurrence"></span></div>
                        <div><strong>Guest:</strong> <span id="v-guest"></span></div>
                        <div><strong>Language:</strong> <span id="v-lang"></span></div>
                    </div>
                    <div class="voucher-footer">
                        <p data-i18n="voucherDisclaimer">Please retain this receipt as proof of your wake-up call request.</p>
                        <small id="v-timestamp"></small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="app.closeModal('voucher-modal')">Close</button>
                <button class="btn btn-primary" onclick="app.printVoucher()"><i class="fas fa-print"></i> Print</button>
            </div>
        </div>
    </div>

    <script>
        const app = {
            data: [],
            blocklist: [],
            currentLang: 'en',
            timerInterval: null,
            audioContext: null,
            activeAlertId: null,
            fabMenuOpen: false,
            
            // PHP backend endpoints
            backendConfig: {
                saveDataUrl: 'save_data.php',
                loadDataUrl: 'load_data.php',
                saveBlocklistUrl: 'save_blocklist.php',
                loadBlocklistUrl: 'load_blocklist.php'
            },

            // Translations Dictionary
            i18n: {
                en: {
                    appTitle: "Hotel Wake-Up Manager",
                    navDash: "Dashboard",
                    navReg: "New Request",
                    navRep: "Reports / Settings",
                    statPending: "Pending Calls",
                    statCompleted: "Completed Today",
                    statTotal: "Total Today",
                    todayCalls: "Today's Schedule",
                    colTime: "Time",
                    colRoom: "Room",
                    colGuest: "Guest Name",
                    colLang: "Language",
                    colStatus: "Status",
                    colAction: "Action",
                    colNotes: "Notes",
                    newRequestTitle: "Register Wake-Up Call",
                    labelRoom: "Room Number *",
                    labelGuest: "Guest Name",
                    labelDate: "Start Date *",
                    labelTime: "Time *",
                    labelRecurrence: "Recurrence",
                    recSingle: "Single Day",
                    recDaily: "Daily (30 days)",
                    recWeekly: "Weekly (12 weeks)",
                    labelLang: "Language Preference",
                    labelNotes: "Special Notes",
                    btnReset: "Reset",
                    btnSave: "Save Request",
                    btnRefresh: "Refresh",
                    filterDate: "Select Date",
                    reportsTitle: "Reports & Tools",
                    reportSectionTitle: "Daily Call Report",
                    blocklistTitle: "Room Blocklist (DND/OOS)",
                    blocklistDesc: "Prevents wake-up calls from being registered for these rooms.",
                    addBlock: "Block",
                    alertTitle: "WAKE UP CALL DUE",
                    btnComplete: "Mark Completed",
                    voucherTitle: "Request Confirmation",
                    voucherDisclaimer: "Please retain this receipt as proof of your wake-up call request.",
                    statusOnline: "System Active - PHP Backend",
                    statusOffline: "Offline - Using Local Storage",
                    noCalls: "No calls scheduled for today.",
                    loading: "Loading..."
                },
                fr: {
                    appTitle: "Gestionnaire Réveil Hôtel",
                    navDash: "Tableau de Bord",
                    navReg: "Nouveau Réveil",
                    navRep: "Rapports / Paramètres",
                    statPending: "En Attente",
                    statCompleted: "Terminés",
                    statTotal: "Total",
                    todayCalls: "Planning du Jour",
                    colTime: "Heure",
                    colRoom: "Chambre",
                    colGuest: "Nom Client",
                    colLang: "Langue",
                    colStatus: "Statut",
                    colAction: "Action",
                    colNotes: "Notes",
                    newRequestTitle: "Enregistrer un Réveil",
                    labelRoom: "Numéro Chambre *",
                    labelGuest: "Nom Client",
                    labelDate: "Date de début *",
                    labelTime: "Heure *",
                    labelRecurrence: "Récurrence",
                    recSingle: "Jour Unique",
                    recDaily: "Quotidien (30 jours)",
                    recWeekly: "Hebdomadaire (12 semaines)",
                    labelLang: "Préférence Langue",
                    labelNotes: "Notes Spéciales",
                    btnReset: "Réinitialiser",
                    btnSave: "Enregistrer",
                    btnRefresh: "Rafraîchir",
                    filterDate: "Choisir une Date",
                    reportsTitle: "Rapports & Outils",
                    reportSectionTitle: "Rapport d'Appels",
                    blocklistTitle: "Liste Noire (NPD/HSC)",
                    blocklistDesc: "Empêche l'enregistrement d'appels de réveil pour ces chambres.",
                    addBlock: "Bloquer",
                    alertTitle: "APPEL DE RÉVEIL",
                    btnComplete: "Marquer Terminé",
                    voucherTitle: "Confirmation Demande",
                    voucherDisclaimer: "Veuillez conserver ce reçu comme preuve de votre demande.",
                    statusOnline: "Système Actif - Backend PHP",
                    statusOffline: "Hors Ligne - Stockage Local",
                    noCalls: "Aucun appel prévu aujourd'hui.",
                    loading: "Chargement..."
                }
            },

            async init() {
                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('reg-date').value = today;
                document.getElementById('report-date').value = today;

                // Start clock & monitor
                this.updateClock();
                setInterval(() => this.updateClock(), 1000);
                setInterval(() => this.checkAlerts(), 30000); // Check every 30s

                // Load data
                await this.loadData();

                // Load lang
                const savedLang = localStorage.getItem('hotel_lang');
                if (savedLang) this.currentLang = savedLang;

                // Initial render
                this.updateUIText();
                this.renderDashboard();
                this.renderBlocklist();
                this.checkOnlineStatus();
                
                // Setup mobile FAB
                this.setupMobileFab();
            },
            
            setupMobileFab() {
                // Close FAB menu when clicking outside
                document.addEventListener('click', (e) => {
                    const fabContainer = document.querySelector('.fab-container');
                    const fabMenu = document.getElementById('fab-menu');
                    
                    if (this.fabMenuOpen && !fabContainer.contains(e.target)) {
                        this.closeFabMenu();
                    }
                });
            },
            
            toggleFabMenu() {
                const fabMenu = document.getElementById('fab-menu');
                if (this.fabMenuOpen) {
                    this.closeFabMenu();
                } else {
                    fabMenu.classList.add('active');
                    this.fabMenuOpen = true;
                }
            },
            
            closeFabMenu() {
                const fabMenu = document.getElementById('fab-menu');
                fabMenu.classList.remove('active');
                this.fabMenuOpen = false;
            },
            
            checkOnlineStatus() {
                const isOnline = navigator.onLine;
                const indicator = document.getElementById('online-indicator');
                const statusText = document.getElementById('status-text');
                
                if (isOnline) {
                    indicator.classList.remove('offline-status');
                    indicator.style.animation = 'pulse-green 2s infinite';
                    if (statusText) statusText.textContent = this.i18n[this.currentLang].statusOnline;
                } else {
                    indicator.classList.add('offline-status');
                    indicator.style.animation = 'pulse-red 1.5s infinite';
                    if (statusText) statusText.textContent = this.i18n[this.currentLang].statusOffline;
                }
            },

            // --- PHP BACKEND STORAGE FUNCTIONS ---
            async loadData() {
                try {
                    if (navigator.onLine) {
                        // Try to load from PHP backend
                        const [dataResponse, blocklistResponse] = await Promise.all([
                            fetch(this.backendConfig.loadDataUrl),
                            fetch(this.backendConfig.loadBlocklistUrl)
                        ]);
                        
                        if (dataResponse.ok) {
                            const result = await dataResponse.json();
                            if (result.success) {
                                this.data = result.data || [];
                            }
                        }
                        
                        if (blocklistResponse.ok) {
                            const result = await blocklistResponse.json();
                            if (result.success) {
                                this.blocklist = result.data || [];
                            }
                        }
                    }
                } catch (error) {
                    console.warn('PHP backend unavailable, using local storage as fallback');
                    // Fallback to localStorage
                    const stored = localStorage.getItem('hotel_wakeup_data');
                    if (stored) this.data = JSON.parse(stored);
                    
                    const blockStored = localStorage.getItem('hotel_blocklist');
                    if (blockStored) this.blocklist = JSON.parse(blockStored);
                }
            },
            
            async saveData() {
                try {
                    if (navigator.onLine) {
                        // Save to PHP backend
                        const response = await fetch(this.backendConfig.saveDataUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ data: this.data })
                        });
                        
                        const result = await response.json();
                        if (!result.success) {
                            throw new Error('PHP save failed');
                        }
                    }
                    
                    // Always keep localStorage as backup
                    localStorage.setItem('hotel_wakeup_data', JSON.stringify(this.data));
                    return true;
                } catch (error) {
                    console.warn('PHP backend save failed, using local storage');
                    localStorage.setItem('hotel_wakeup_data', JSON.stringify(this.data));
                    return false;
                }
            },
            
            async saveBlocklist() {
                try {
                    if (navigator.onLine) {
                        // Save to PHP backend
                        const response = await fetch(this.backendConfig.saveBlocklistUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ data: this.blocklist })
                        });
                        
                        const result = await response.json();
                        if (!result.success) {
                            throw new Error('PHP save failed');
                        }
                    }
                    
                    // Always keep localStorage as backup
                    localStorage.setItem('hotel_blocklist', JSON.stringify(this.blocklist));
                    return true;
                } catch (error) {
                    console.warn('PHP backend save failed, using local storage');
                    localStorage.setItem('hotel_blocklist', JSON.stringify(this.blocklist));
                    return false;
                }
            },
            
            // --- NAVIGATION & UI ---
            navigate(sectionId) {
                document.querySelectorAll('section').forEach(el => el.classList.remove('active'));
                document.getElementById(sectionId).classList.add('active');
                
                document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
                document.getElementById(sectionId === 'dashboard' ? 'nav-dash' : sectionId === 'register' ? 'nav-reg' : 'nav-rep').classList.add('active');

                if (sectionId === 'dashboard') this.renderDashboard();
                if (sectionId === 'reports') {
                    this.renderReport();
                    this.renderBlocklist();
                }
                
                // Close mobile menu if open
                this.closeFabMenu();
            },

            toggleLanguage() {
                this.currentLang = this.currentLang === 'en' ? 'fr' : 'en';
                localStorage.setItem('hotel_lang', this.currentLang);
                this.updateUIText();
                this.renderDashboard(); 
                this.renderBlocklist();
                this.renderReport();
                
                // Close mobile menu if open
                this.closeFabMenu();
            },

            updateUIText() {
                const t = this.i18n[this.currentLang];
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (t[key]) el.textContent = t[key];
                });
                document.getElementById('lang-label').textContent = this.currentLang === 'en' ? 'EN' : 'FR';
            },

            updateClock() {
                const now = new Date();
                document.getElementById('clock').textContent = now.toLocaleTimeString('en-GB', { hour12: false });
            },

            // --- BLOCKLIST MANAGEMENT ---
            async addBlockRoom() {
                const room = document.getElementById('block-room-input').value.trim().toUpperCase();
                if (!room) return;
                
                const blockBtn = document.getElementById('block-btn');
                const originalText = blockBtn.innerHTML;
                
                if (!this.blocklist.includes(room)) {
                    // Show loading
                    blockBtn.innerHTML = '<span class="loader"></span> Blocking...';
                    blockBtn.disabled = true;
                    
                    this.blocklist.push(room);
                    const success = await this.saveBlocklist();
                    this.renderBlocklist();
                    document.getElementById('block-room-input').value = '';
                    
                    // Restore button
                    setTimeout(() => {
                        blockBtn.innerHTML = originalText;
                        blockBtn.disabled = false;
                    }, 500);
                    
                    if (success) {
                        console.log(`Room ${room} blocked successfully`);
                    }
                } else {
                    alert(`Room ${room} is already blocked.`);
                }
            },

            async removeBlockRoom(room) {
                this.blocklist = this.blocklist.filter(r => r !== room);
                await this.saveBlocklist();
                this.renderBlocklist();
            },
            
            renderBlocklist() {
                const ul = document.getElementById('blocklist-ul');
                ul.innerHTML = '';
                
                // Update blocked rooms count
                document.getElementById('count-blocked').textContent = this.blocklist.length;
                
                if (this.blocklist.length === 0) {
                    ul.innerHTML = `<li style="color: var(--text-gray); padding: 15px; text-align: center; background: rgba(0,0,0,0.02); border-radius: 12px;">No rooms currently blocked.</li>`;
                    return;
                }
                
                this.blocklist.forEach(room => {
                    const li = document.createElement('li');
                    li.classList.add('blocklist-item');
                    li.innerHTML = `
                        <span style="display: flex; align-items: center; gap: 10px;"><i class="fas fa-bed" style="color: #e74c3c;"></i> <strong>${room}</strong></span>
                        <button class="btn-remove-block" onclick="app.removeBlockRoom('${room}')" title="Unblock"><i class="fas fa-times-circle"></i></button>
                    `;
                    ul.appendChild(li);
                });
            },

            // --- REGISTRATION ---
            async handleRegister(e) {
                e.preventDefault();
                
                const room = document.getElementById('reg-room').value.trim().toUpperCase();
                const date = document.getElementById('reg-date').value;
                const time = document.getElementById('reg-time').value;
                const recurrence = document.getElementById('reg-recurrence').value;
                const saveBtn = document.getElementById('save-btn');
                const originalText = saveBtn.innerHTML;
                
                // Show loading
                saveBtn.innerHTML = '<span class="loader"></span> Saving...';
                saveBtn.disabled = true;
                
                // 1. Blocklist Validation
                if (this.blocklist.includes(room)) {
                    alert(`ERROR: Room ${room} is on the Blocklist (DND/OOS). Cannot register call.`);
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                    return;
                }
                
                // 2. Initial Date Validation
                const now = new Date();
                const scheduleDate = new Date(date + 'T' + time);
                if (scheduleDate < now) {
                    alert("Cannot schedule calls in the past.");
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                    return;
                }

                // 3. Generate Calls based on Recurrence
                const newCalls = [];
                const baseCall = {
                    roomNumber: room,
                    guestName: document.getElementById('reg-name').value.trim() || 'Guest',
                    time: time,
                    language: document.getElementById('reg-lang').value,
                    notes: document.getElementById('reg-notes').value.trim(),
                    status: 'pending',
                    requestedAt: new Date().toISOString(),
                    completedAt: null
                };

                let iterations = 1;
                if (recurrence === 'daily') iterations = 30; // 30 days max
                if (recurrence === 'weekly') iterations = 12; // 12 weeks max
                
                let currentDate = new Date(date); // Start date

                for (let i = 0; i < iterations; i++) {
                    const callDateStr = currentDate.toISOString().split('T')[0];
                    
                    // Check duplicate for this specific date
                    const exists = this.data.find(c => c.date === callDateStr && c.time === time && c.roomNumber === room && c.status === 'pending');
                    if (exists) {
                        // Skip this date, continue to the next one
                        currentDate = this.getNextDate(currentDate, recurrence);
                        continue;
                    }
                    
                    const call = {
                        ...baseCall,
                        id: Date.now().toString() + i, // unique ID
                        reference: `WUC-${callDateStr.replace(/-/g, '')}-${i.toString().padStart(2, '0')}`,
                        date: callDateStr,
                        recurrenceType: recurrence 
                    };
                    newCalls.push(call);
                    
                    currentDate = this.getNextDate(currentDate, recurrence);
                }

                if (newCalls.length === 0) {
                    alert("Registration failed: All requested time slots were already booked or in the past.");
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                    return;
                }

                this.data.push(...newCalls);
                const success = await this.saveData();
                this.showVoucher(baseCall, date, recurrence, newCalls.length);
                this.resetForm();
                
                // Restore button
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                
                if (success) {
                    console.log('Data saved to PHP backend successfully');
                }
            },
            
            getNextDate(currentDate, recurrence) {
                const nextDate = new Date(currentDate);
                if (recurrence === 'daily') {
                    nextDate.setDate(nextDate.getDate() + 1);
                } else if (recurrence === 'weekly') {
                    nextDate.setDate(nextDate.getDate() + 7);
                }
                return nextDate;
            },

            resetForm() {
                document.getElementById('wakeup-form').reset();
                document.getElementById('reg-date').value = new Date().toISOString().split('T')[0];
            },

            async markCompleted(id) {
                const call = this.data.find(c => c.id === id);
                if (call) {
                    if (confirm("Confirm wake-up call completed?")) {
                        call.status = 'completed';
                        call.completedAt = new Date().toISOString();
                        await this.saveData();
                        this.renderDashboard();
                        
                        // If it was the active alert
                        if (this.activeAlertId === id) {
                            this.closeModal('alert-modal');
                            this.stopAlarm();
                        }
                    }
                }
            },

            // --- DASHBOARD ---
            async renderDashboard() {
                const refreshBtn = document.getElementById('refresh-btn');
                const originalText = refreshBtn.innerHTML;
                
                // Show loading
                refreshBtn.innerHTML = '<span class="loader"></span> Loading...';
                refreshBtn.disabled = true;
                
                // Refresh data from storage
                await this.loadData();
                
                const today = new Date().toISOString().split('T')[0];
                // Filter out records older than 30 days just to keep the data clean and dashboard fast
                const thirtyDaysAgo = new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0];
                
                this.data = this.data.filter(c => c.date >= thirtyDaysAgo || c.date === today); 
                await this.saveData(); // Save cleaned up list
                
                const calls = this.data.filter(c => c.date === today).sort((a,b) => a.time.localeCompare(b.time));
                
                // Update counters
                const total = calls.length;
                const completed = calls.filter(c => c.status === 'completed').length;
                const pending = total - completed;

                document.getElementById('count-pending').textContent = pending;
                document.getElementById('count-completed').textContent = completed;
                document.getElementById('count-total').textContent = total;

                // Render Table
                const tbody = document.getElementById('dashboard-body');
                tbody.innerHTML = '';

                if (calls.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 40px;">
                        <div style="font-size: 3rem; color: rgba(52, 152, 219, 0.2); margin-bottom: 10px;"><i class="fas fa-bed"></i></div>
                        <div style="color: var(--text-gray); font-size: 1.1rem;">${this.i18n[this.currentLang].noCalls}</div>
                    </td></tr>`;
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                    return;
                }

                calls.forEach(call => {
                    const statusClass = call.status === 'completed' ? 'badge-completed' : 'badge-pending';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong style="font-size: 1.1rem;">${call.time}</strong></td>
                        <td><i class="fas fa-door-closed" style="color: #3498db; margin-right: 8px;"></i> <strong>${call.roomNumber}</strong></td>
                        <td>${call.guestName}</td>
                        <td>${call.language}</td>
                        <td><span class="badge ${statusClass}">${call.status.toUpperCase()}</span></td>
                        <td>
                            ${call.status === 'pending' ? 
                                `<button class="btn btn-success" style="padding: 8px 16px; border-radius: 8px;" onclick="app.markCompleted('${call.id}')"><i class="fas fa-check"></i> Complete</button>` 
                                : '<i class="fas fa-check-circle" style="color: #27ae60; font-size: 1.2rem;"></i>'}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
                // Restore button
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
            },

            // --- ALERTS ---
            checkAlerts() {
                const now = new Date();
                const currentDate = now.toISOString().split('T')[0];
                // Get HH:MM format
                const currentTime = now.toLocaleTimeString('en-GB', { hour12: false }).substring(0, 5);

                const dueCall = this.data.find(c => 
                    c.date === currentDate && 
                    c.time === currentTime && 
                    c.status === 'pending'
                );

                if (dueCall && this.activeAlertId !== dueCall.id) {
                    this.triggerAlert(dueCall);
                }
            },

            triggerAlert(call) {
                this.activeAlertId = call.id;
                
                // Populate Modal
                document.getElementById('alert-time').textContent = call.time;
                document.getElementById('alert-room').textContent = call.roomNumber;
                document.getElementById('alert-guest').textContent = call.guestName;
                document.getElementById('alert-lang').textContent = call.language;
                document.getElementById('alert-notes').textContent = call.notes ? `Note: ${call.notes}` : '';
                
                // Bind Button
                const btn = document.getElementById('btn-complete-call');
                btn.onclick = () => this.markCompleted(call.id);

                // Show & Play
                document.getElementById('alert-modal').classList.add('open');
                this.playAlarmSound();
            },

            playAlarmSound() {
                // Using Web Audio API for no-asset sound
                if (!this.audioContext) this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                const playBeep = () => {
                    if (this.activeAlertId === null) return; // Stop if alert dismissed
                    
                    const osc = this.audioContext.createOscillator();
                    const gain = this.audioContext.createGain();
                    
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(440, this.audioContext.currentTime); // A4
                    osc.frequency.exponentialRampToValueAtTime(880, this.audioContext.currentTime + 0.1); // Slide up
                    
                    gain.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.5);

                    osc.connect(gain);
                    gain.connect(this.audioContext.destination);
                    
                    osc.start();
                    osc.stop(this.audioContext.currentTime + 0.5);
                };

                // Play immediately then loop
                playBeep();
                this.timerInterval = setInterval(playBeep, 2000); // Beep every 2 seconds
            },

            stopAlarm() {
                clearInterval(this.timerInterval);
                this.activeAlertId = null;
            },

            // --- VOUCHERS ---
            showVoucher(call, startDate, recurrence, count) {
                document.querySelector('#voucher-ref').textContent = `REF: ${call.reference}`;
                document.getElementById('v-room').textContent = call.roomNumber;
                document.getElementById('v-date').textContent = startDate;
                document.getElementById('v-time').textContent = call.time;
                
                let recurrenceText = recurrence === 'single' ? 'Single Day' : 
                                     recurrence === 'daily' ? `Daily (${count} instances)` : 
                                     `Weekly (${count} instances)`;

                document.getElementById('v-recurrence').textContent = recurrenceText;
                document.getElementById('v-guest').textContent = call.guestName;
                document.getElementById('v-lang').textContent = call.language;
                document.getElementById('v-timestamp').textContent = "Issued: " + new Date(call.requestedAt).toLocaleString();
                
                document.getElementById('voucher-modal').classList.add('open');
            },

            printVoucher() {
                // Clone the voucher, put it in a printable wrapper
                const content = document.getElementById('printable-voucher').innerHTML;
                const printArea = document.createElement('div');
                printArea.id = 'printable-area';
                printArea.innerHTML = `<div style="padding: 40px; border: 1px solid #ccc;">${content}</div>`;
                document.body.appendChild(printArea);
                window.print();
                document.body.removeChild(printArea);
            },

            closeModal(id) {
                document.getElementById(id).classList.remove('open');
                if (id === 'alert-modal') this.stopAlarm();
            },

            // --- REPORTS ---
            async renderReport() {
                const date = document.getElementById('report-date').value;
                const calls = this.data.filter(c => c.date === date).sort((a,b) => a.time.localeCompare(b.time));
                
                const tbody = document.getElementById('report-body');
                tbody.innerHTML = '';

                if (calls.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 40px;">
                        <div style="font-size: 3rem; color: rgba(52, 152, 219, 0.2); margin-bottom: 10px;"><i class="fas fa-file-alt"></i></div>
                        <div style="color: var(--text-gray);">No records for this date.</div>
                    </td></tr>`;
                    return;
                }

                calls.forEach(call => {
                    const statusClass = call.status === 'completed' ? 'badge-completed' : 
                                       call.status === 'pending' ? 'badge-pending' : '';
                    
                    tbody.innerHTML += `
                        <tr>
                            <td><small>${call.reference}</small></td>
                            <td><strong>${call.time}</strong></td>
                            <td>${call.roomNumber}</td>
                            <td>${call.guestName}</td>
                            <td><span class="badge ${statusClass}" style="padding: 5px 10px;">${call.status.toUpperCase()}</span></td>
                            <td><small>${call.notes || '-'}</small></td>
                        </tr>
                    `;
                });
            },

            async exportReportPDF() {
                const date = document.getElementById('report-date').value;
                const calls = this.data.filter(c => c.date === date).sort((a,b) => a.time.localeCompare(b.time));
                const pdfBtn = document.getElementById('pdf-btn');
                const originalText = pdfBtn.innerHTML;
                
                if (calls.length === 0) { 
                    alert("No data to export"); 
                    return; 
                }

                // Show loading
                pdfBtn.innerHTML = '<span class="loader"></span> Generating...';
                pdfBtn.disabled = true;
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(18);
                doc.text(`Wake-Up Call Report: ${date}`, 14, 22);
                doc.setFontSize(11);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 30);

                const rows = calls.map(c => [c.time, c.roomNumber, c.guestName, c.language, c.status.toUpperCase(), c.notes]);

                doc.autoTable({
                    head: [['Time', 'Room', 'Guest', 'Lang', 'Status', 'Notes']],
                    body: rows,
                    startY: 40,
                });

                doc.save(`wakeup_report_${date}.pdf`);
                
                // Restore button
                pdfBtn.innerHTML = originalText;
                pdfBtn.disabled = false;
            },

            exportReportCSV() {
                const date = document.getElementById('report-date').value;
                const calls = this.data.filter(c => c.date === date);
                const csvBtn = document.getElementById('csv-btn');
                const originalText = csvBtn.innerHTML;
                
                if (calls.length === 0) { 
                    alert("No data to export"); 
                    return; 
                }

                // Show loading
                csvBtn.innerHTML = '<span class="loader"></span> Exporting...';
                csvBtn.disabled = true;
                
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Reference,Date,Time,Room,Guest,Language,Status,Notes\n";

                calls.forEach(c => {
                    const row = [
                        c.reference, c.date, c.time, c.roomNumber, 
                        `"${c.guestName}"`, c.language, c.status, `"${c.notes}"`
                    ].join(",");
                    csvContent += row + "\r\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `wakeup_report_${date}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Restore button
                setTimeout(() => {
                    csvBtn.innerHTML = originalText;
                    csvBtn.disabled = false;
                }, 500);
            }
        };

        // Start App
        document.addEventListener('DOMContentLoaded', () => app.init());
        window.addEventListener('online', app.checkOnlineStatus);
        window.addEventListener('offline', app.checkOnlineStatus);
    </script>
</body>
</html>
